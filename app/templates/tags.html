{% extends "base.html" %}

{% block title %}Tag Management{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-tags"></i> Tag Management</h2>
</div>

<div class="row">
    <!-- Tag Creation Section -->
    <div class="col-lg-4 mb-4">
        {% if not current_user.is_readonly %}
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-plus-circle"></i> Create Tag</h5>
            </div>
            <div class="card-body">
                <form id="create-tag-form">
                    <div class="mb-3">
                        <label for="tag-name" class="form-label">Tag Name</label>
                        <input type="text" class="form-control" id="tag-name" name="name" required maxlength="50" placeholder="e.g., Main, Alt, Farm">
                    </div>
                    <div class="mb-3">
                        <label for="tag-color" class="form-label">Color</label>
                        <select class="form-select" id="tag-color" name="color">
                            <option value="primary">Blue</option>
                            <option value="success">Green</option>
                            <option value="danger">Red</option>
                            <option value="warning">Yellow</option>
                            <option value="info">Cyan</option>
                            <option value="secondary" selected>Gray</option>
                            <option value="dark">Dark</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-plus"></i> Create Tag
                    </button>
                </form>
            </div>
        </div>
        {% endif %}

        <!-- Existing Tags -->
        <div class="card {% if not current_user.is_readonly %}mt-3{% endif %}">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-collection"></i> Existing Tags</h5>
            </div>
            <div class="card-body">
                {% if tags %}
                <div class="d-flex flex-wrap gap-2" id="tags-list">
                    {% for tag in tags %}
                    <span class="badge bg-{{ tag.color }} tag-badge d-flex align-items-center gap-1" data-tag-id="{{ tag.id }}">
                        {{ tag.name }}
                        {% if not current_user.is_readonly %}
                        <button type="button" class="btn-close btn-close-white ms-1" style="font-size: 0.6em;" onclick="deleteTag({{ tag.id }}, '{{ tag.name }}')" title="Delete tag"></button>
                        {% endif %}
                    </span>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted mb-0" id="no-tags-msg">No tags created yet.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- FC Tag Assignments Section -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-diagram-3"></i> FC Tag Assignments</h5>
                <div class="input-group" style="max-width: 250px;">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" id="fc-search" placeholder="Search FCs...">
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-dark table-hover mb-0" id="fc-tags-table">
                        <thead>
                            <tr>
                                <th>FC Name</th>
                                <th>Character</th>
                                <th>Tags</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for fc in fcs %}
                            <tr data-fc-id="{{ fc.fc_id }}" data-fc-name="{{ fc.fc_name|lower }}" data-character="{{ fc.character|lower }}">
                                <td><strong>{{ fc.fc_name }}</strong></td>
                                <td>
                                    {{ fc.character }}
                                    {% if fc.world %}
                                    <br><small class="text-muted">{{ fc.world }}</small>
                                    {% endif %}
                                </td>
                                <td class="fc-tags-cell">
                                    <div class="d-flex flex-wrap gap-1 align-items-center">
                                        {% for tag in fc.tags %}
                                        <span class="badge bg-{{ tag.color }} fc-tag" data-tag-id="{{ tag.id }}">
                                            {{ tag.name }}
                                            {% if not current_user.is_readonly %}
                                            <button type="button" class="btn-close btn-close-white ms-1" style="font-size: 0.5em;" onclick="unassignTag('{{ fc.fc_id }}', {{ tag.id }})" title="Remove tag"></button>
                                            {% endif %}
                                        </span>
                                        {% endfor %}
                                        {% if not current_user.is_readonly %}
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle py-0 px-1" type="button" data-bs-toggle="dropdown" aria-expanded="false" title="Add tag">
                                                <i class="bi bi-plus"></i>
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-dark">
                                                {% for tag in tags %}
                                                <li>
                                                    <a class="dropdown-item" href="#" onclick="assignTag('{{ fc.fc_id }}', {{ tag.id }}); return false;">
                                                        <span class="badge bg-{{ tag.color }} me-2">{{ tag.name }}</span>
                                                    </a>
                                                </li>
                                                {% endfor %}
                                                {% if not tags %}
                                                <li><span class="dropdown-item text-muted">No tags available</span></li>
                                                {% endif %}
                                            </ul>
                                        </div>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.tag-badge {
    font-size: 0.9em;
    padding: 0.5em 0.8em;
}

.fc-tag {
    font-size: 0.8em;
}

.fc-tags-cell {
    min-width: 200px;
}

#fc-tags-table tbody tr.hidden {
    display: none;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Create tag form
document.getElementById('create-tag-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const name = document.getElementById('tag-name').value.trim();
    const color = document.getElementById('tag-color').value;

    if (!name) return;

    try {
        const resp = await fetch('/tags/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ name, color })
        });

        const data = await resp.json();

        if (data.success) {
            // Reload page to show new tag
            window.location.reload();
        } else {
            alert(data.message || 'Failed to create tag');
        }
    } catch (err) {
        console.error('Error creating tag:', err);
        alert('Error creating tag');
    }
});

// Delete tag
async function deleteTag(tagId, tagName) {
    if (!confirm(`Delete tag "${tagName}"? This will remove it from all FCs.`)) {
        return;
    }

    try {
        const resp = await fetch(`/tags/delete/${tagId}`, {
            method: 'POST',
            credentials: 'same-origin'
        });

        const data = await resp.json();

        if (data.success) {
            window.location.reload();
        } else {
            alert(data.message || 'Failed to delete tag');
        }
    } catch (err) {
        console.error('Error deleting tag:', err);
        alert('Error deleting tag');
    }
}

// Assign tag to FC
async function assignTag(fcId, tagId) {
    try {
        const resp = await fetch('/tags/assign', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ fc_id: fcId, tag_id: tagId })
        });

        const data = await resp.json();

        if (data.success) {
            window.location.reload();
        } else {
            alert(data.message || 'Failed to assign tag');
        }
    } catch (err) {
        console.error('Error assigning tag:', err);
        alert('Error assigning tag');
    }
}

// Unassign tag from FC
async function unassignTag(fcId, tagId) {
    try {
        const resp = await fetch('/tags/unassign', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ fc_id: fcId, tag_id: tagId })
        });

        const data = await resp.json();

        if (data.success) {
            window.location.reload();
        } else {
            alert(data.message || 'Failed to remove tag');
        }
    } catch (err) {
        console.error('Error removing tag:', err);
        alert('Error removing tag');
    }
}

// Search/filter FCs
document.getElementById('fc-search').addEventListener('input', function() {
    const query = this.value.toLowerCase().trim();
    const rows = document.querySelectorAll('#fc-tags-table tbody tr');

    rows.forEach(row => {
        const fcName = row.dataset.fcName || '';
        const character = row.dataset.character || '';
        if (query === '' || fcName.includes(query) || character.includes(query)) {
            row.classList.remove('hidden');
        } else {
            row.classList.add('hidden');
        }
    });
});
</script>
{% endblock %}
