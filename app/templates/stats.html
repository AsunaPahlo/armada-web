{% extends "base.html" %}

{% block title %}Statistics{% endblock %}

{% block extra_css %}
<style>
.filter-tag-btn, .filter-region-btn { border: 1px solid rgba(255,255,255,0.2); color: rgba(255,255,255,0.8); background: transparent; transition: all 0.15s; }
.filter-tag-btn:hover, .filter-region-btn:hover { border-color: rgba(255,255,255,0.5); color: #fff; }
.filter-tag-btn.active { opacity: 0.5; text-decoration: line-through; }
.filter-region-btn.btn-outline-secondary { opacity: 0.4; }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2><i class="bi bi-graph-up"></i> Statistics</h2>
    <div class="btn-group" id="day-filter-buttons">
        <a href="{{ url_for('stats.index', days=1) }}" class="btn btn-outline-secondary {% if days == 1 %}active{% endif %}" data-days="1">1 Day</a>
        <a href="{{ url_for('stats.index', days=7) }}" class="btn btn-outline-secondary {% if days == 7 %}active{% endif %}" data-days="7">7 Days</a>
        <a href="{{ url_for('stats.index', days=30) }}" class="btn btn-outline-secondary {% if days == 30 %}active{% endif %}" data-days="30">30 Days</a>
        <a href="{{ url_for('stats.index', days=90) }}" class="btn btn-outline-secondary {% if days == 90 %}active{% endif %}" data-days="90">90 Days</a>
        <a href="{{ url_for('stats.index', days=0) }}" class="btn btn-outline-secondary {% if days == 0 %}active{% endif %}" data-days="0">All</a>
    </div>
</div>

<!-- Filter Bar -->
{% if all_tags or all_regions %}
<div class="d-flex flex-wrap align-items-center gap-2 mb-4" id="filter-bar">
    {% if all_tags %}
    <span class="text-muted small me-1">Exclude:</span>
    {% for tag in all_tags %}
    <button class="btn btn-sm filter-tag-btn {% if tag.id in exclude_tag_ids %}active{% endif %}"
            data-tag-id="{{ tag.id }}"
            data-color="{{ tag.color }}"
            style="{% if tag.id in exclude_tag_ids %}opacity: 0.5; text-decoration: line-through;{% endif %}">
        <span class="badge bg-{{ tag.color }} me-1">&nbsp;</span>{{ tag.name }}
    </button>
    {% endfor %}
    <span class="text-muted mx-2">|</span>
    {% endif %}
    <span class="text-muted small me-1">Regions:</span>
    {% for region in all_regions %}
    <button class="btn btn-sm filter-region-btn {% if region in active_regions %}btn-outline-light{% else %}btn-outline-secondary{% endif %}"
            data-region="{{ region }}"
            style="{% if region not in active_regions %}opacity: 0.4;{% endif %}">
        {{ region }}
    </button>
    {% endfor %}
    <button class="btn btn-sm btn-outline-danger ms-2" id="clear-filters-btn" title="Clear all filters"
            style="{% if not exclude_tag_ids and active_regions|length == all_regions|length %}display:none{% endif %}">
        <i class="bi bi-x-circle"></i> Clear
    </button>
</div>
{% endif %}

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card summary-card">
            <div class="card-body d-flex align-items-center justify-content-center">
                <i class="bi bi-compass fs-1 text-muted me-3"></i>
                <div>
                    <h6 class="text-muted mb-0">Total Voyages</h6>
                    <h2 class="mb-0">{{ summary.total_voyages }}</h2>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card summary-card">
            <div class="card-body d-flex align-items-center justify-content-center">
                <i class="bi bi-speedometer2 fs-1 text-muted me-3"></i>
                <div>
                    <h6 class="text-muted mb-0">Avg Voyages/Day</h6>
                    <h2 class="mb-0">{{ summary.avg_voyages_per_day }}</h2>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card summary-card">
            <div class="card-body d-flex align-items-center justify-content-center">
                <i class="bi bi-coin fs-1 text-success me-3"></i>
                <div>
                    <h6 class="text-muted mb-0">Farming Subs</h6>
                    <h2 class="mb-0 text-success">{{ fleet_summary.farming_subs }}</h2>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card summary-card">
            <div class="card-body d-flex align-items-center justify-content-center">
                <i class="bi bi-arrow-up-circle fs-1 text-warning me-3"></i>
                <div>
                    <h6 class="text-muted mb-0">Leveling Subs</h6>
                    <h2 class="mb-0 text-warning">{{ fleet_summary.leveling_subs }}</h2>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Fleet Overview -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-globe"></i> FCs by Region</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col">
                        <h3 class="text-primary mb-0">{{ region_counts.get('NA', 0) }}</h3>
                        <small class="text-muted">NA</small>
                    </div>
                    <div class="col">
                        <h3 class="text-success mb-0">{{ region_counts.get('EU', 0) }}</h3>
                        <small class="text-muted">EU</small>
                    </div>
                    <div class="col">
                        <h3 class="text-danger mb-0">{{ region_counts.get('JP', 0) }}</h3>
                        <small class="text-muted">JP</small>
                    </div>
                    <div class="col">
                        <h3 class="text-warning mb-0">{{ region_counts.get('OCE', 0) }}</h3>
                        <small class="text-muted">OCE</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-building"></i> Fleet Overview</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col">
                        <h3 class="mb-0">{{ fleet_summary.fc_count }}</h3>
                        <small class="text-muted">Total FCs</small>
                    </div>
                    <div class="col">
                        <h3 class="mb-0">{{ fleet_summary.total_subs }}</h3>
                        <small class="text-muted">Submarines</small>
                    </div>
                    <div class="col">
                        <h3 class="text-warning mb-0">{{ "{:,.0f}".format(fleet_summary.total_gil_per_day) }}</h3>
                        <small class="text-muted">Gil/Day</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row 1 -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-graph-up"></i> Voyages Over Time</h5>
            </div>
            <div class="card-body">
                <canvas id="voyages-chart" height="120"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-bar-chart-steps"></i> Submarine Levels</h5>
            </div>
            <div class="card-body">
                <canvas id="level-chart" height="120"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row 2 -->
<div class="row mb-4">
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-signpost-split"></i> Most Popular Routes</h5>
            </div>
            <div class="card-body">
                <canvas id="routes-chart" height="200"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-clock"></i> Activity by Hour</h5>
            </div>
            <div class="card-body">
                <canvas id="hour-chart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row 3 -->
<div class="row mb-4">
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-building"></i> Voyages by FC</h5>
            </div>
            <div class="card-body">
                <canvas id="fc-voyages-chart" height="200"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-fuel-pump"></i> Days Until Restock</h5>
            </div>
            <div class="card-body">
                <canvas id="supply-chart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row 4 -->
<div class="row mb-4">
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-trophy"></i> Top Submarines</h5>
            </div>
            <div class="card-body">
                <canvas id="top-subs-chart" height="200"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-wrench"></i> Popular Builds</h5>
            </div>
            <div class="card-body">
                <canvas id="builds-chart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
// === Filter Bar Logic ===
(function() {
    const STORAGE_KEY = 'armada_stats_filters';
    const currentDays = {{ days }};
    const allRegions = {{ all_regions|tojson }};

    function getFiltersFromStorage() {
        try {
            const stored = localStorage.getItem(STORAGE_KEY);
            return stored ? JSON.parse(stored) : {};
        } catch(e) { return {}; }
    }

    function saveFiltersToStorage(filters) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(filters));
    }

    function buildFilteredUrl(days, excludeTags, regions) {
        const url = new URL(window.location.pathname, window.location.origin);
        url.searchParams.set('days', days);
        if (excludeTags.length > 0) {
            url.searchParams.set('exclude_tags', excludeTags.join(','));
        }
        if (regions.length > 0 && regions.length < allRegions.length) {
            url.searchParams.set('regions', regions.join(','));
        }
        return url.toString();
    }

    // Read current state from URL params (which were set from server)
    let excludeTagIds = {{ exclude_tag_ids|tojson }};
    let activeRegions = {{ active_regions|tojson }};

    // On first load with no URL filter params, try to restore from localStorage
    const urlParams = new URLSearchParams(window.location.search);
    if (!urlParams.has('exclude_tags') && !urlParams.has('regions')) {
        const stored = getFiltersFromStorage();
        if (stored.excludeTags?.length > 0 || (stored.regions?.length > 0 && stored.regions.length < allRegions.length)) {
            // Redirect with stored filters
            window.location.href = buildFilteredUrl(currentDays, stored.excludeTags || [], stored.regions || allRegions);
            return;
        }
    }

    // Save current state to localStorage
    saveFiltersToStorage({ excludeTags: excludeTagIds, regions: activeRegions });

    // Update day selector links to preserve current filters
    document.querySelectorAll('#day-filter-buttons a').forEach(link => {
        const linkDays = link.getAttribute('data-days');
        link.href = buildFilteredUrl(linkDays, excludeTagIds, activeRegions);
    });

    // Tag exclusion buttons
    document.querySelectorAll('.filter-tag-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const tagId = parseInt(this.getAttribute('data-tag-id'));
            const idx = excludeTagIds.indexOf(tagId);
            if (idx >= 0) {
                excludeTagIds.splice(idx, 1);
            } else {
                excludeTagIds.push(tagId);
            }
            saveFiltersToStorage({ excludeTags: excludeTagIds, regions: activeRegions });
            window.location.href = buildFilteredUrl(currentDays, excludeTagIds, activeRegions);
        });
    });

    // Region filter buttons
    document.querySelectorAll('.filter-region-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const region = this.getAttribute('data-region');
            const idx = activeRegions.indexOf(region);
            if (idx >= 0 && activeRegions.length > 1) {
                activeRegions.splice(idx, 1);
            } else if (idx < 0) {
                activeRegions.push(region);
            }
            saveFiltersToStorage({ excludeTags: excludeTagIds, regions: activeRegions });
            window.location.href = buildFilteredUrl(currentDays, excludeTagIds, activeRegions);
        });
    });

    // Clear filters button
    const clearBtn = document.getElementById('clear-filters-btn');
    if (clearBtn) {
        clearBtn.addEventListener('click', function() {
            excludeTagIds = [];
            activeRegions = allRegions.slice();
            saveFiltersToStorage({ excludeTags: [], regions: allRegions });
            window.location.href = buildFilteredUrl(currentDays, [], allRegions);
        });
    }
})();

// Chart data from server (non-timezone-sensitive)
const supplyData = {{ supply_data|tojson }};
const fleetChartData = {{ fleet_chart_data|tojson }};

// Common chart options for dark theme
const darkThemeOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
        legend: {
            labels: { color: 'rgba(255,255,255,0.7)' }
        }
    },
    scales: {
        y: {
            beginAtZero: true,
            grid: { color: 'rgba(255,255,255,0.1)' },
            ticks: { color: 'rgba(255,255,255,0.7)' }
        },
        x: {
            grid: { color: 'rgba(255,255,255,0.1)' },
            ticks: { color: 'rgba(255,255,255,0.7)' }
        }
    }
};

// Fetch voyage chart data with client timezone
(function() {
    const apiUrl = new URL('{{ url_for("stats.api_voyage_chart") }}', window.location.origin);
    apiUrl.searchParams.set('days', {{ days }});
    apiUrl.searchParams.set('tz', new Date().getTimezoneOffset());
    {% if exclude_tag_ids %}
    apiUrl.searchParams.set('exclude_tags', {{ exclude_tag_ids|tojson }}.join(','));
    {% endif %}
    {% if active_regions|length < all_regions|length %}
    apiUrl.searchParams.set('regions', {{ active_regions|tojson }}.join(','));
    {% endif %}

    fetch(apiUrl)
        .then(response => response.json())
        .then(chartData => {
            // 1. Voyages Over Time Chart
            const voyagesCtx = document.getElementById('voyages-chart').getContext('2d');
            const byDate = chartData.by_date || [];
            const last14Days = byDate.slice(-14);

            new Chart(voyagesCtx, {
                type: 'line',
                data: {
                    labels: last14Days.map(d => d.date.slice(5)),
                    datasets: [{
                        label: 'Voyages',
                        data: last14Days.map(d => d.total),
                        borderColor: 'rgba(99, 179, 237, 1)',
                        backgroundColor: 'rgba(99, 179, 237, 0.2)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    ...darkThemeOptions,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });

            // 3. Most Popular Routes Chart
            const routesCtx = document.getElementById('routes-chart').getContext('2d');
            const byRoute = chartData.by_route || [];

            new Chart(routesCtx, {
                type: 'bar',
                data: {
                    labels: byRoute.map(r => r.route.length > 20 ? r.route.slice(0, 20) + '...' : r.route),
                    datasets: [{
                        label: 'Voyages',
                        data: byRoute.map(r => r.count),
                        backgroundColor: 'rgba(168, 85, 247, 0.7)',
                        borderColor: 'rgba(168, 85, 247, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    ...darkThemeOptions,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } }
                }
            });

            // 4. Activity by Hour Chart
            const hourCtx = document.getElementById('hour-chart').getContext('2d');
            const byHour = chartData.by_hour || [];

            new Chart(hourCtx, {
                type: 'bar',
                data: {
                    labels: byHour.map(h => h.hour.toString().padStart(2, '0') + ':00'),
                    datasets: [{
                        label: 'Voyages',
                        data: byHour.map(h => h.count),
                        backgroundColor: 'rgba(237, 137, 54, 0.7)',
                        borderColor: 'rgba(237, 137, 54, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    ...darkThemeOptions,
                    plugins: { legend: { display: false } },
                    scales: {
                        ...darkThemeOptions.scales,
                        x: {
                            ...darkThemeOptions.scales.x,
                            ticks: {
                                color: 'rgba(255,255,255,0.7)',
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });

            // 5. Voyages by FC Chart
            const fcVoyagesCtx = document.getElementById('fc-voyages-chart').getContext('2d');
            const byFC = chartData.by_fc || [];

            new Chart(fcVoyagesCtx, {
                type: 'bar',
                data: {
                    labels: byFC.map(fc => fc.fc_name.length > 15 ? fc.fc_name.slice(0, 15) + '...' : fc.fc_name),
                    datasets: [{
                        label: 'Voyages',
                        data: byFC.map(fc => fc.total),
                        backgroundColor: 'rgba(99, 179, 237, 0.7)',
                        borderColor: 'rgba(99, 179, 237, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    ...darkThemeOptions,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } }
                }
            });

            // 7. Top Submarines Chart
            const topSubsCtx = document.getElementById('top-subs-chart').getContext('2d');
            const topSubs = chartData.top_submarines || [];

            new Chart(topSubsCtx, {
                type: 'bar',
                data: {
                    labels: topSubs.map(s => s.name),
                    datasets: [{
                        label: 'Voyages',
                        data: topSubs.map(s => s.count),
                        backgroundColor: 'rgba(72, 187, 120, 0.7)',
                        borderColor: 'rgba(72, 187, 120, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    ...darkThemeOptions,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } }
                }
            });
        });
})();

// 2. Submarine Level Distribution Chart
const levelCtx = document.getElementById('level-chart').getContext('2d');
const levelDist = fleetChartData.level_distribution || {};
const levelLabels = ['1-20', '21-40', '41-60', '61-80', '81-100', '100+'];
const levelColors = [
    'rgba(160, 174, 192, 0.7)',
    'rgba(99, 179, 237, 0.7)',
    'rgba(72, 187, 120, 0.7)',
    'rgba(237, 137, 54, 0.7)',
    'rgba(237, 100, 166, 0.7)',
    'rgba(168, 85, 247, 0.7)'
];

new Chart(levelCtx, {
    type: 'bar',
    data: {
        labels: levelLabels,
        datasets: [{
            label: 'Submarines',
            data: levelLabels.map(l => levelDist[l] || 0),
            backgroundColor: levelColors,
            borderColor: levelColors.map(c => c.replace('0.7', '1')),
            borderWidth: 1
        }]
    },
    options: {
        ...darkThemeOptions,
        plugins: { legend: { display: false } }
    }
});

// 6. Supply Levels Chart (Days Until Restock)
const supplyCtx = document.getElementById('supply-chart').getContext('2d');
const supplyFiltered = supplyData.filter(s => s.days_until_restock !== null).slice(0, 10);

new Chart(supplyCtx, {
    type: 'bar',
    data: {
        labels: supplyFiltered.map(s => s.fc_name.length > 15 ? s.fc_name.slice(0, 15) + '...' : s.fc_name),
        datasets: [{
            label: 'Days',
            data: supplyFiltered.map(s => s.days_until_restock),
            backgroundColor: supplyFiltered.map(s => {
                if (s.days_until_restock <= 3) return 'rgba(245, 101, 101, 0.7)';
                if (s.days_until_restock <= 7) return 'rgba(237, 137, 54, 0.7)';
                return 'rgba(72, 187, 120, 0.7)';
            }),
            borderColor: supplyFiltered.map(s => {
                if (s.days_until_restock <= 3) return 'rgba(245, 101, 101, 1)';
                if (s.days_until_restock <= 7) return 'rgba(237, 137, 54, 1)';
                return 'rgba(72, 187, 120, 1)';
            }),
            borderWidth: 1
        }]
    },
    options: {
        ...darkThemeOptions,
        indexAxis: 'y',
        plugins: { legend: { display: false } }
    }
});

// 8. Popular Builds Chart
const buildsCtx = document.getElementById('builds-chart').getContext('2d');
const topBuilds = fleetChartData.top_builds || [];

new Chart(buildsCtx, {
    type: 'bar',
    data: {
        labels: topBuilds.map(b => b.build),
        datasets: [{
            label: 'Submarines',
            data: topBuilds.map(b => b.count),
            backgroundColor: 'rgba(237, 100, 166, 0.7)',
            borderColor: 'rgba(237, 100, 166, 1)',
            borderWidth: 1
        }]
    },
    options: {
        ...darkThemeOptions,
        indexAxis: 'y',
        plugins: { legend: { display: false } }
    }
});
</script>
{% endblock %}
