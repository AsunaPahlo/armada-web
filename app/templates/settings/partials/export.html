<div class="settings-section-header">
    <h2><i class="bi bi-download"></i> Export Data</h2>
</div>

<p class="text-muted mb-4">
    Download your fleet data as CSV files. These can be opened in Excel, Google Sheets, or any spreadsheet application.
</p>

<div class="settings-card" style="padding: 0;">
    <div class="list-group list-group-flush">
        <!-- Free Companies Export -->
        <div class="list-group-item d-flex justify-content-between align-items-center bg-transparent">
            <div>
                <h6 class="mb-1"><i class="bi bi-building text-info"></i> Free Companies</h6>
                <small class="text-muted">FC ID, name, holder character, world, housing info, submarine count</small>
            </div>
            <a href="/export/fc" class="btn btn-outline-info btn-sm">
                <i class="bi bi-download"></i> Download
            </a>
        </div>

        <!-- Characters Export -->
        <div class="list-group-item d-flex justify-content-between align-items-center bg-transparent">
            <div>
                <h6 class="mb-1"><i class="bi bi-person text-success"></i> Characters</h6>
                <small class="text-muted">Character name, ID, world, FC name, submarine count</small>
            </div>
            <a href="/export/characters" class="btn btn-outline-success btn-sm">
                <i class="bi bi-download"></i> Download
            </a>
        </div>

        <!-- Submarines Export -->
        <div class="list-group-item d-flex justify-content-between align-items-center bg-transparent">
            <div>
                <h6 class="mb-1"><i class="bi bi-water text-primary"></i> Submarines</h6>
                <small class="text-muted">Character, FC, submarine name, level, build, status, return time, route</small>
            </div>
            <a href="/export/submarines" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-download"></i> Download
            </a>
        </div>

        <!-- Voyage Loot Export -->
        <div class="list-group-item bg-transparent">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h6 class="mb-1"><i class="bi bi-gem text-warning"></i> Voyage Loot</h6>
                    <small class="text-muted">Timestamp, character, FC, submarine, route, items, quantities, gil value</small>
                </div>
            </div>
            <div class="mt-3">
                <form id="loot-export-form" class="row g-2 align-items-end">
                    <div class="col-auto">
                        <label for="export-start-date" class="form-label small text-muted mb-1">Start Date</label>
                        <input type="date" class="form-control form-control-sm" id="export-start-date" name="start_date">
                    </div>
                    <div class="col-auto">
                        <label for="export-end-date" class="form-label small text-muted mb-1">End Date</label>
                        <input type="date" class="form-control form-control-sm" id="export-end-date" name="end_date">
                    </div>
                    <div class="col-auto">
                        <label class="form-label small text-muted mb-1">&nbsp;</label>
                        <div>
                            <button type="button" class="btn btn-outline-warning btn-sm" onclick="downloadLoot()">
                                <i class="bi bi-download"></i> Download
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearExportDates()">
                                Clear
                            </button>
                        </div>
                    </div>
                    <div class="col-auto">
                        <small class="text-muted">Leave dates empty for last 30 days</small>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Google Sheets Integration -->
<div class="settings-card mt-3">
    <div class="settings-card-title">
        <i class="bi bi-table"></i> Google Sheets Integration
    </div>
    <p class="text-muted small">
        Connect Google Sheets to automatically pull FC data using Apps Script.
        This provides: Character @ World, FC Name, Datacenter, World, Housing Area, Ward, Plot, Route, and House Size.
    </p>

    <div class="mb-3">
        <label class="form-label small">API Token</label>
        <div class="input-group input-group-sm">
            <input type="text" class="form-control font-monospace" id="sheets-token" readonly placeholder="No token generated">
            <button class="btn btn-outline-primary" type="button" id="copy-token-btn" title="Copy to clipboard">
                <i class="bi bi-clipboard"></i>
            </button>
            <button class="btn btn-primary" type="button" id="generate-token-btn">
                <i class="bi bi-key"></i> Generate
            </button>
        </div>
        <small class="text-muted">This token allows Google Sheets to access your FC data. Keep it secret.</small>
    </div>

    <div class="mb-3">
        <label class="form-label small">API Endpoint</label>
        <div class="input-group input-group-sm">
            <input type="text" class="form-control font-monospace" id="sheets-api-url" readonly value="">
            <button class="btn btn-outline-primary" type="button" id="copy-url-btn" title="Copy to clipboard">
                <i class="bi bi-clipboard"></i>
            </button>
        </div>
    </div>

    <details class="mt-3">
        <summary class="text-muted small" style="cursor: pointer;"><i class="bi bi-code-slash"></i> Google Apps Script (click to expand)</summary>
        <div class="position-relative mt-2">
            <pre class="bg-dark p-2 rounded small" style="max-height: 300px; overflow-y: auto;"><code id="apps-script-code">// Armada Fleet Google Sheets Integration
const API_URL = 'YOUR_API_URL_HERE';

// Color scheme
const COLORS = {
  header: '#1a1a2e',
  headerText: '#ffffff',
  rowEven: '#f8f9fa',
  rowOdd: '#ffffff',
  border: '#dee2e6',
  leveling: '#fff3cd',
  levelingText: '#856404'
};

function refreshAllData() {
  const data = fetchArmadaData();
  if (!data) return;

  let totalCount = 0;
  const updatedAt = data.generated_at ? new Date(data.generated_at) : new Date();

  // Untagged FCs go to "Untagged" sheet
  if (data.untagged && data.untagged.length > 0) {
    updateSheet('Untagged', data.columns, data.untagged, updatedAt);
    totalCount += data.untagged.length;
  }

  // Tagged FCs go to their respective tag sheets
  for (const [tagName, rows] of Object.entries(data.by_tag)) {
    updateSheet(tagName, data.columns, rows, updatedAt);
    totalCount += rows.length;
  }

  SpreadsheetApp.getActiveSpreadsheet().toast(
    'Updated ' + totalCount + ' FCs', 'Sync Complete'
  );
}

function fetchArmadaData() {
  try {
    const response = UrlFetchApp.fetch(API_URL, {muteHttpExceptions: true});
    if (response.getResponseCode() !== 200) {
      SpreadsheetApp.getUi().alert('Error: ' + response.getContentText());
      return null;
    }
    return JSON.parse(response.getContentText());
  } catch (e) {
    SpreadsheetApp.getUi().alert('Failed: ' + e.message);
    return null;
  }
}

function updateSheet(sheetName, columns, rows, updatedAt) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let sheet = ss.getSheetByName(sheetName);
  if (!sheet) sheet = ss.insertSheet(sheetName);
  sheet.clear();

  // Add "Last Updated" timestamp in row 1
  const formattedDate = updatedAt.toLocaleString();
  sheet.getRange(1, 1).setValue('Last Updated: ' + formattedDate)
    .setFontStyle('italic')
    .setFontColor('#6c757d');
  sheet.getRange(1, 1, 1, columns.length).merge();

  // Format headers (row 2, after timestamp)
  const headers = columns.map(c =>
    c.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ')
  );
  const headerRange = sheet.getRange(2, 1, 1, headers.length);
  headerRange.setValues([headers])
    .setFontWeight('bold')
    .setBackground(COLORS.header)
    .setFontColor(COLORS.headerText)
    .setHorizontalAlignment('center');

  // Freeze header row (row 2)
  sheet.setFrozenRows(2);

  if (rows.length > 0) {
    const dataRows = rows.map(row => columns.map(col => row[col] || ''));
    const dataRange = sheet.getRange(3, 1, dataRows.length, columns.length);
    dataRange.setValues(dataRows);

    // Alternating row colors
    for (let i = 0; i < dataRows.length; i++) {
      const rowRange = sheet.getRange(i + 3, 1, 1, columns.length);
      rowRange.setBackground(i % 2 === 0 ? COLORS.rowEven : COLORS.rowOdd);
    }

    // Add borders to all data (header + data rows)
    const allDataRange = sheet.getRange(2, 1, rows.length + 1, columns.length);
    allDataRange.setBorder(true, true, true, true, true, true,
      COLORS.border, SpreadsheetApp.BorderStyle.SOLID);

    // Highlight LEVELING cells in Route column
    const routeIdx = columns.indexOf('route');
    if (routeIdx !== -1) {
      for (let i = 0; i < dataRows.length; i++) {
        if (dataRows[i][routeIdx] === 'LEVELING') {
          const cell = sheet.getRange(i + 3, routeIdx + 1);
          cell.setBackground(COLORS.leveling)
            .setFontColor(COLORS.levelingText)
            .setFontWeight('bold');
        }
      }
    }
  }

  // Auto-resize columns then add padding
  for (let i = 1; i <= columns.length; i++) {
    sheet.autoResizeColumn(i);
    const currentWidth = sheet.getColumnWidth(i);
    sheet.setColumnWidth(i, currentWidth + 20);
  }

  // Add filter to make it a proper table with dropdowns (starting at row 2)
  if (rows.length > 0) {
    const filterRange = sheet.getRange(2, 1, rows.length + 1, columns.length);
    const existingFilter = sheet.getFilter();
    if (existingFilter) existingFilter.remove();
    filterRange.createFilter();
  }
}

function onOpen() {
  SpreadsheetApp.getUi().createMenu('Armada')
    .addItem('Refresh Data', 'refreshAllData')
    .addToUi();
}</code></pre>
            <button class="btn btn-sm btn-outline-secondary position-absolute top-0 end-0 m-1" onclick="copyScript()">
                <i class="bi bi-clipboard"></i>
            </button>
        </div>
    </details>
</div>

<div class="settings-card mt-3">
    <div class="settings-card-title">
        <i class="bi bi-info-circle"></i> Export Information
    </div>
    <ul class="text-muted mb-0 small">
        <li><strong>Free Companies</strong> - Lists all FCs with their housing information and total submarine count.</li>
        <li><strong>Characters</strong> - Lists all characters linked to the fleet with their FC associations.</li>
        <li><strong>Submarines</strong> - Current state of all submarines including their build configuration and voyage status.</li>
        <li><strong>Voyage Loot</strong> - Historical loot data with per-sector item breakdowns and gil values. Use date filters for large exports.</li>
    </ul>
</div>

<script>
function downloadLoot() {
    const startDate = document.getElementById('export-start-date').value;
    const endDate = document.getElementById('export-end-date').value;

    let url = '/export/loot';
    const params = new URLSearchParams();

    if (startDate) params.append('start_date', startDate);
    if (endDate) params.append('end_date', endDate);

    if (params.toString()) {
        url += '?' + params.toString();
    }

    window.location.href = url;
}

function clearExportDates() {
    document.getElementById('export-start-date').value = '';
    document.getElementById('export-end-date').value = '';
}

// Google Sheets Integration
(function() {
    const baseUrl = window.location.origin;
    const apiEndpoint = '/export/api/sheets';

    function loadSheetsToken() {
        fetch('/export/sheets/token')
            .then(response => response.json())
            .then(data => updateTokenDisplay(data.token))
            .catch(err => console.error('Failed to load token:', err));
    }

    function updateTokenDisplay(token) {
        const tokenInput = document.getElementById('sheets-token');
        const urlInput = document.getElementById('sheets-api-url');
        if (!tokenInput || !urlInput) return;

        if (token) {
            tokenInput.value = token;
            urlInput.value = baseUrl + apiEndpoint + '?token=' + token;
        } else {
            tokenInput.value = '';
            tokenInput.placeholder = 'No token generated - click Generate';
            urlInput.value = '';
        }
    }

    const generateBtn = document.getElementById('generate-token-btn');
    if (generateBtn) {
        generateBtn.addEventListener('click', function() {
            if (!confirm('Generate a new token? This will invalidate the previous token.')) return;
            fetch('/export/sheets/token', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    updateTokenDisplay(data.token);
                    alert('New token generated successfully!');
                })
                .catch(err => {
                    console.error('Failed to generate token:', err);
                    alert('Failed to generate token');
                });
        });
    }

    const copyTokenBtn = document.getElementById('copy-token-btn');
    if (copyTokenBtn) {
        copyTokenBtn.addEventListener('click', function() {
            const tokenInput = document.getElementById('sheets-token');
            if (tokenInput && tokenInput.value) {
                navigator.clipboard.writeText(tokenInput.value);
                this.innerHTML = '<i class="bi bi-check"></i>';
                setTimeout(() => { this.innerHTML = '<i class="bi bi-clipboard"></i>'; }, 2000);
            }
        });
    }

    const copyUrlBtn = document.getElementById('copy-url-btn');
    if (copyUrlBtn) {
        copyUrlBtn.addEventListener('click', function() {
            const urlInput = document.getElementById('sheets-api-url');
            if (urlInput && urlInput.value) {
                navigator.clipboard.writeText(urlInput.value);
                this.innerHTML = '<i class="bi bi-check"></i>';
                setTimeout(() => { this.innerHTML = '<i class="bi bi-clipboard"></i>'; }, 2000);
            }
        });
    }

    // Load token on page load
    loadSheetsToken();
})();

function copyScript() {
    const code = document.getElementById('apps-script-code');
    if (code) {
        navigator.clipboard.writeText(code.textContent);
        const btn = event.target.closest('button');
        if (btn) {
            btn.innerHTML = '<i class="bi bi-check"></i>';
            setTimeout(() => { btn.innerHTML = '<i class="bi bi-clipboard"></i>'; }, 2000);
        }
    }
}
</script>
