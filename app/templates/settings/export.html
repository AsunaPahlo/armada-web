{% extends "base.html" %}

{% block title %}Export Data{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-download"></i> Export Data</h2>
</div>

<div class="row">
    <div class="col-lg-10 mx-auto">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-file-earmark-spreadsheet"></i> Available Exports</h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-4">
                    Download your fleet data as CSV files. These can be opened in Excel, Google Sheets, or any spreadsheet application.
                </p>

                <div class="list-group">
                    <!-- Free Companies Export -->
                    <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center bg-dark">
                        <div>
                            <h6 class="mb-1"><i class="bi bi-building text-info"></i> Free Companies</h6>
                            <small class="text-muted">FC ID, name, holder character, world, housing info, submarine count</small>
                        </div>
                        <a href="{{ url_for('export.export_fc') }}" class="btn btn-outline-info btn-sm">
                            <i class="bi bi-download"></i> Download
                        </a>
                    </div>

                    <!-- Characters Export -->
                    <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center bg-dark">
                        <div>
                            <h6 class="mb-1"><i class="bi bi-person text-success"></i> Characters</h6>
                            <small class="text-muted">Character name, ID, world, FC name, submarine count</small>
                        </div>
                        <a href="{{ url_for('export.export_characters') }}" class="btn btn-outline-success btn-sm">
                            <i class="bi bi-download"></i> Download
                        </a>
                    </div>

                    <!-- Submarines Export -->
                    <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center bg-dark">
                        <div>
                            <h6 class="mb-1"><i class="bi bi-water text-primary"></i> Submarines</h6>
                            <small class="text-muted">Character, FC, submarine name, level, build, status, return time, route</small>
                        </div>
                        <a href="{{ url_for('export.export_submarines') }}" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-download"></i> Download
                        </a>
                    </div>

                    <!-- Voyage Loot Export -->
                    <div class="list-group-item bg-dark">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1"><i class="bi bi-gem text-warning"></i> Voyage Loot</h6>
                                <small class="text-muted">Timestamp, character, FC, submarine, route, items, quantities, gil value</small>
                            </div>
                        </div>
                        <div class="mt-3">
                            <form id="loot-export-form" class="row g-2 align-items-end">
                                <div class="col-auto">
                                    <label for="start-date" class="form-label small text-muted mb-1">Start Date</label>
                                    <input type="date" class="form-control form-control-sm" id="start-date" name="start_date">
                                </div>
                                <div class="col-auto">
                                    <label for="end-date" class="form-label small text-muted mb-1">End Date</label>
                                    <input type="date" class="form-control form-control-sm" id="end-date" name="end_date">
                                </div>
                                <div class="col-auto">
                                    <label class="form-label small text-muted mb-1">&nbsp;</label>
                                    <div>
                                        <button type="button" class="btn btn-outline-warning btn-sm" onclick="downloadLoot()">
                                            <i class="bi bi-download"></i> Download
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearDates()">
                                            Clear
                                        </button>
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <small class="text-muted">Leave dates empty for last 30 days</small>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Google Sheets Integration -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-table"></i> Google Sheets Integration</h5>
            </div>
            <div class="card-body">
                <p class="text-muted">
                    Connect Google Sheets to automatically pull FC data using Apps Script.
                    This provides: Character @ World, FC Name, Datacenter, World, Housing Area, Ward, Plot, Route, and House Size.
                </p>

                <div class="mb-3">
                    <label class="form-label">API Token</label>
                    <div class="input-group">
                        <input type="text" class="form-control font-monospace" id="sheets-token" readonly placeholder="No token generated">
                        <button class="btn btn-outline-primary" type="button" id="copy-token-btn" title="Copy to clipboard">
                            <i class="bi bi-clipboard"></i>
                        </button>
                        <button class="btn btn-primary" type="button" id="generate-token-btn">
                            <i class="bi bi-key"></i> Generate New Token
                        </button>
                    </div>
                    <small class="text-muted">This token allows Google Sheets to access your FC data. Keep it secret.</small>
                </div>

                <div class="mb-3">
                    <label class="form-label">API Endpoint</label>
                    <div class="input-group">
                        <input type="text" class="form-control font-monospace" id="sheets-api-url" readonly value="">
                        <button class="btn btn-outline-primary" type="button" id="copy-url-btn" title="Copy to clipboard">
                            <i class="bi bi-clipboard"></i>
                        </button>
                    </div>
                </div>

                <hr>

                <h6><i class="bi bi-code-slash"></i> Google Apps Script</h6>
                <p class="text-muted small">
                    Copy this script into your Google Sheet (Extensions > Apps Script). Then run <code>refreshAllData()</code> or set up a time-based trigger.
                </p>
                <div class="position-relative">
                    <pre class="bg-dark p-3 rounded" style="max-height: 300px; overflow-y: auto;"><code id="apps-script-code">// Armada Fleet Google Sheets Integration
const API_URL = 'YOUR_API_URL_HERE';

// Color scheme
const COLORS = {
  header: '#1a1a2e',
  headerText: '#ffffff',
  rowEven: '#f8f9fa',
  rowOdd: '#ffffff',
  border: '#dee2e6',
  leveling: '#fff3cd',
  levelingText: '#856404'
};

function refreshAllData() {
  const data = fetchArmadaData();
  if (!data) return;

  let totalCount = 0;

  // Untagged FCs go to "Untagged" sheet
  if (data.untagged && data.untagged.length > 0) {
    updateSheet('Untagged', data.columns, data.untagged);
    totalCount += data.untagged.length;
  }

  // Tagged FCs go to their respective tag sheets
  for (const [tagName, rows] of Object.entries(data.by_tag)) {
    updateSheet(tagName, data.columns, rows);
    totalCount += rows.length;
  }

  SpreadsheetApp.getActiveSpreadsheet().toast(
    'Updated ' + totalCount + ' FCs', 'Sync Complete'
  );
}

function fetchArmadaData() {
  try {
    const response = UrlFetchApp.fetch(API_URL, {muteHttpExceptions: true});
    if (response.getResponseCode() !== 200) {
      SpreadsheetApp.getUi().alert('Error: ' + response.getContentText());
      return null;
    }
    return JSON.parse(response.getContentText());
  } catch (e) {
    SpreadsheetApp.getUi().alert('Failed: ' + e.message);
    return null;
  }
}

function updateSheet(sheetName, columns, rows) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let sheet = ss.getSheetByName(sheetName);
  if (!sheet) sheet = ss.insertSheet(sheetName);
  sheet.clear();

  // Format headers
  const headers = columns.map(c =>
    c.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ')
  );
  const headerRange = sheet.getRange(1, 1, 1, headers.length);
  headerRange.setValues([headers])
    .setFontWeight('bold')
    .setBackground(COLORS.header)
    .setFontColor(COLORS.headerText)
    .setHorizontalAlignment('center');

  // Freeze header row
  sheet.setFrozenRows(1);

  if (rows.length > 0) {
    const dataRows = rows.map(row => columns.map(col => row[col] || ''));
    const dataRange = sheet.getRange(2, 1, dataRows.length, columns.length);
    dataRange.setValues(dataRows);

    // Alternating row colors
    for (let i = 0; i < dataRows.length; i++) {
      const rowRange = sheet.getRange(i + 2, 1, 1, columns.length);
      rowRange.setBackground(i % 2 === 0 ? COLORS.rowEven : COLORS.rowOdd);
    }

    // Add borders to all data
    const allDataRange = sheet.getRange(1, 1, rows.length + 1, columns.length);
    allDataRange.setBorder(true, true, true, true, true, true,
      COLORS.border, SpreadsheetApp.BorderStyle.SOLID);

    // Highlight LEVELING cells in Route column
    const routeIdx = columns.indexOf('route');
    if (routeIdx !== -1) {
      for (let i = 0; i < dataRows.length; i++) {
        if (dataRows[i][routeIdx] === 'LEVELING') {
          const cell = sheet.getRange(i + 2, routeIdx + 1);
          cell.setBackground(COLORS.leveling)
            .setFontColor(COLORS.levelingText)
            .setFontWeight('bold');
        }
      }
    }
  }

  // Auto-resize columns
  for (let i = 1; i <= columns.length; i++) {
    sheet.autoResizeColumn(i);
  }
}

function onOpen() {
  SpreadsheetApp.getUi().createMenu('Armada')
    .addItem('Refresh Data', 'refreshAllData')
    .addToUi();
}</code></pre>
                    <button class="btn btn-sm btn-outline-secondary position-absolute top-0 end-0 m-2" onclick="copyScript()">
                        <i class="bi bi-clipboard"></i> Copy
                    </button>
                </div>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Export Information</h5>
            </div>
            <div class="card-body">
                <ul class="text-muted mb-0">
                    <li><strong>Free Companies</strong> - Lists all FCs with their housing information and total submarine count.</li>
                    <li><strong>Characters</strong> - Lists all characters linked to the fleet with their FC associations.</li>
                    <li><strong>Submarines</strong> - Current state of all submarines including their build configuration and voyage status.</li>
                    <li><strong>Voyage Loot</strong> - Historical loot data with per-sector item breakdowns and gil values. Use date filters for large exports.</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function downloadLoot() {
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value;

    let url = '{{ url_for("export.export_loot") }}';
    const params = new URLSearchParams();

    if (startDate) params.append('start_date', startDate);
    if (endDate) params.append('end_date', endDate);

    if (params.toString()) {
        url += '?' + params.toString();
    }

    window.location.href = url;
}

function clearDates() {
    document.getElementById('start-date').value = '';
    document.getElementById('end-date').value = '';
}

// Set default dates (last 30 days)
document.addEventListener('DOMContentLoaded', function() {
    const endDate = new Date();
    const startDate = new Date();
    startDate.setDate(startDate.getDate() - 30);

    // Don't pre-fill to show "last 30 days" default behavior
    // document.getElementById('start-date').value = startDate.toISOString().split('T')[0];
    // document.getElementById('end-date').value = endDate.toISOString().split('T')[0];

    // Load existing token
    loadSheetsToken();
});

// Google Sheets Integration
const baseUrl = window.location.origin;
const apiEndpoint = '/export/api/sheets';

function loadSheetsToken() {
    fetch('{{ url_for("export.get_sheets_token") }}')
        .then(response => response.json())
        .then(data => {
            updateTokenDisplay(data.token);
        })
        .catch(err => console.error('Failed to load token:', err));
}

function updateTokenDisplay(token) {
    const tokenInput = document.getElementById('sheets-token');
    const urlInput = document.getElementById('sheets-api-url');

    if (token) {
        tokenInput.value = token;
        urlInput.value = baseUrl + apiEndpoint + '?token=' + token;
    } else {
        tokenInput.value = '';
        tokenInput.placeholder = 'No token generated - click Generate';
        urlInput.value = '';
    }
}

document.getElementById('generate-token-btn').addEventListener('click', function() {
    if (!confirm('Generate a new token? This will invalidate the previous token.')) {
        return;
    }

    fetch('{{ url_for("export.generate_sheets_token") }}', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            updateTokenDisplay(data.token);
            alert('New token generated successfully!');
        })
        .catch(err => {
            console.error('Failed to generate token:', err);
            alert('Failed to generate token');
        });
});

document.getElementById('copy-token-btn').addEventListener('click', function() {
    const tokenInput = document.getElementById('sheets-token');
    if (tokenInput.value) {
        navigator.clipboard.writeText(tokenInput.value);
        this.innerHTML = '<i class="bi bi-check"></i>';
        setTimeout(() => { this.innerHTML = '<i class="bi bi-clipboard"></i>'; }, 2000);
    }
});

document.getElementById('copy-url-btn').addEventListener('click', function() {
    const urlInput = document.getElementById('sheets-api-url');
    if (urlInput.value) {
        navigator.clipboard.writeText(urlInput.value);
        this.innerHTML = '<i class="bi bi-check"></i>';
        setTimeout(() => { this.innerHTML = '<i class="bi bi-clipboard"></i>'; }, 2000);
    }
});

function copyScript() {
    const code = document.getElementById('apps-script-code').textContent;
    navigator.clipboard.writeText(code);

    const btn = event.target.closest('button');
    btn.innerHTML = '<i class="bi bi-check"></i> Copied';
    setTimeout(() => { btn.innerHTML = '<i class="bi bi-clipboard"></i> Copy'; }, 2000);
}
</script>
{% endblock %}
