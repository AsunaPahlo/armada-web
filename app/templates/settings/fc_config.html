{% extends "base.html" %}

{% block title %}FC Configuration{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-sliders"></i> FC Configuration</h2>
</div>

<div class="row">
    <div class="col-lg-10 mx-auto">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-building"></i> Free Companies</h5>
                <div class="input-group" style="max-width: 250px;">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" id="fc-search" placeholder="Search FCs...">
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-dark table-hover mb-0" id="fc-config-table">
                        <thead>
                            <tr>
                                <th>FC Name</th>
                                <th>World</th>
                                <th>House Address</th>
                                <th class="text-center" style="width: 80px;">Subs</th>
                                <th class="text-center" style="width: 100px;">Visible</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for fc in fcs %}
                            <tr data-fc-id="{{ fc.fc_id }}" data-fc-name="{{ fc.fc_name|lower }}" data-world="{{ fc.world|lower }}">
                                <td>
                                    <strong>{{ fc.fc_name }}</strong>
                                    <br><small class="text-muted">{{ fc.character }}</small>
                                </td>
                                <td>{{ fc.world }}</td>
                                <td>
                                    {% if fc.house_address %}
                                        <i class="bi bi-house-door text-info"></i> {{ fc.house_address }}
                                    {% else %}
                                        <span class="text-muted">â€”</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">{{ fc.sub_count }}</td>
                                <td class="text-center">
                                    <button type="button"
                                            class="btn btn-link p-0 toggle-btn{% if current_user.is_readonly %} disabled{% endif %}"
                                            data-fc-id="{{ fc.fc_id }}"
                                            data-setting="visible"
                                            data-value="{{ 'true' if fc.visible else 'false' }}"
                                            title="Toggle visibility"
                                            {% if current_user.is_readonly %}disabled{% endif %}>
                                        <i class="bi bi-eye{% if not fc.visible %}-slash{% endif %} fs-5 {% if fc.visible %}text-info{% else %}text-secondary opacity-50{% endif %}"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> About FC Visibility</h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-0">
                    <i class="bi bi-eye text-info"></i> <strong>Visible</strong> -
                    Controls whether the FC appears in the dashboard, submarine views, and statistics.
                    Hidden FCs are completely excluded from all views and aggregate calculations
                    (total submarines, gil/day, supply forecasts, etc.).
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.toggle-btn {
    transition: transform 0.1s ease;
}

.toggle-btn:hover:not(.disabled) {
    transform: scale(1.2);
}

.toggle-btn.disabled {
    cursor: not-allowed;
}

#fc-config-table tbody tr.hidden {
    display: none;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Toggle button click handlers
document.querySelectorAll('.toggle-btn').forEach(btn => {
    if (btn.classList.contains('disabled')) return;

    btn.addEventListener('click', async function() {
        const fcId = this.dataset.fcId;
        const setting = this.dataset.setting;
        const currentValue = this.dataset.value === 'true';
        const newValue = !currentValue;

        const icon = this.querySelector('i');
        const originalClasses = icon.className;

        // Optimistic UI update for visibility toggle
        if (setting === 'visible') {
            if (newValue) {
                icon.classList.remove('bi-eye-slash', 'text-secondary', 'opacity-50');
                icon.classList.add('bi-eye', 'text-info');
            } else {
                icon.classList.remove('bi-eye', 'text-info');
                icon.classList.add('bi-eye-slash', 'text-secondary', 'opacity-50');
            }
        }
        this.dataset.value = newValue.toString();

        try {
            const resp = await fetch('/settings/fc-config/toggle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify({
                    fc_id: fcId,
                    setting: setting,
                    value: newValue
                })
            });

            const data = await resp.json();

            if (!data.success) {
                // Revert on failure
                icon.className = originalClasses;
                this.dataset.value = currentValue.toString();
                alert(data.message || 'Failed to update setting');
            }
        } catch (err) {
            // Revert on error
            icon.className = originalClasses;
            this.dataset.value = currentValue.toString();
            console.error('Error updating setting:', err);
            alert('Error updating setting');
        }
    });
});

// Search/filter FCs
document.getElementById('fc-search').addEventListener('input', function() {
    const query = this.value.toLowerCase().trim();
    const rows = document.querySelectorAll('#fc-config-table tbody tr');

    rows.forEach(row => {
        const fcName = row.dataset.fcName || '';
        const world = row.dataset.world || '';
        if (query === '' || fcName.includes(query) || world.includes(query)) {
            row.classList.remove('hidden');
        } else {
            row.classList.add('hidden');
        }
    });
});
</script>
{% endblock %}
