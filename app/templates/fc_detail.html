{% extends "base.html" %}

{% block title %}{{ fc_name }}{% endblock %}

{% block content %}
<!-- Header with integrated stats -->
<div class="mb-4">
    <div class="d-flex justify-content-between align-items-start">
        <div class="d-flex align-items-center gap-3">
            <a href="{{ url_for('dashboard.index') }}" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-arrow-left"></i>
            </a>
            <div>
                <h4 class="mb-1">{{ fc_name }}</h4>
                <div class="d-flex flex-wrap align-items-center gap-2 text-muted small">
                    <span>{{ fc_world }}</span>
                    {% if fc_address %}<span><i class="bi bi-house-door"></i> {{ fc_address }}{% if fc_house_size %} <span class="badge bg-secondary">{{ fc_house_size }}</span>{% endif %}</span>{% endif %}
                    <span class="text-muted">|</span>
                    <!-- Inline leveling stats -->
                    <span id="status-badge" class="badge bg-secondary">Loading...</span>
                    <span id="inline-stats" class="d-none">
                        <span id="inline-at-target"></span> at target
                        <span id="inline-leveling-wrap"> · <span id="inline-leveling"></span> leveling</span>
                        <span id="inline-days-wrap"> · ~<span id="inline-days"></span></span>
                    </span>
                </div>
            </div>
        </div>
        <div class="d-flex gap-2 align-items-center">
            <a href="{{ url_for('unlocks.index') }}?fc_id={{ fc_id }}" class="btn btn-outline-info btn-sm">
                <i class="bi bi-diagram-3"></i> Unlocks
            </a>
            <form class="d-flex align-items-center gap-1" method="POST" action="{{ url_for('stats.fc_leveling_settings', fc_id=fc_id) }}">
                <span class="text-muted small">Target:</span>
                <input type="number" class="form-control form-control-sm" id="target_level" name="target_level"
                       value="{{ target_level }}" min="1" max="125" style="width: 65px;">
                <button type="submit" class="btn btn-sm btn-primary"><i class="bi bi-check"></i></button>
            </form>
        </div>
    </div>
</div>

<!-- Main Content Grid -->
<div class="row g-4">
    <!-- Left Column: Submarines + Activity -->
    <div class="col-lg-8">
        <!-- Submarines -->
        <div class="card mb-4">
            <div class="card-header py-2 d-flex justify-content-between align-items-center">
                <span><i class="bi bi-water me-2"></i>Submarines</span>
                <span class="badge bg-secondary" id="sub-count">{{ total_subs }}</span>
            </div>
            <div class="table-responsive">
                <table class="table table-hover table-sm mb-0" id="sub-table">
                    <thead>
                        <tr class="text-muted small">
                            <th class="fw-normal ps-3">Name</th>
                            <th class="fw-normal text-center">Level</th>
                            <th class="fw-normal">Build</th>
                            <th class="fw-normal text-center leveling-col">Est.</th>
                            <th class="fw-normal text-center pe-3">Status</th>
                        </tr>
                    </thead>
                    <tbody id="sub-tbody">
                        <tr>
                            <td colspan="5" class="text-center text-muted py-4">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                                <span class="ms-2">Loading...</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Activity Log -->
        <div class="card">
            <div class="card-header py-2 d-flex justify-content-between align-items-center">
                <span><i class="bi bi-clock-history me-2"></i>Recent Activity</span>
                <div class="d-flex align-items-center gap-2">
                    <small class="text-muted" id="activity-range"></small>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-secondary py-0 px-1" id="activity-prev" disabled><i class="bi bi-chevron-left"></i></button>
                        <button class="btn btn-outline-secondary py-0 px-1" id="activity-next" disabled><i class="bi bi-chevron-right"></i></button>
                    </div>
                </div>
            </div>
            <div class="card-body py-2" id="activity-list">
                <div class="text-center text-muted py-3">
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                    <span class="ms-2">Loading...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Column: Leveling + Notes + Extras -->
    <div class="col-lg-4">
        <!-- Leveling Estimates -->
        <div class="card mb-3" id="leveling-card">
            <div class="card-header py-2">
                <i class="bi bi-graph-up me-2"></i>Leveling Progress
            </div>
            <div class="card-body py-3">
                <div class="progress mb-3" style="height: 8px;" id="leveling-progress">
                    <div class="progress-bar bg-secondary" style="width: 100%"></div>
                </div>
                <div class="row text-center g-2 mb-2" id="estimate-tiers">
                    <div class="col-4">
                        <small class="text-success d-block">Optimistic</small>
                        <strong class="text-success" id="est-optimistic">-</strong>
                    </div>
                    <div class="col-4">
                        <small class="text-warning d-block">Expected</small>
                        <strong class="text-warning" id="est-expected">-</strong>
                    </div>
                    <div class="col-4">
                        <small class="text-danger d-block">Pessimistic</small>
                        <strong class="text-danger" id="est-pessimistic">-</strong>
                    </div>
                </div>
                <div class="text-center">
                    <small class="text-muted" id="slowest-sub-info"></small>
                </div>
                <!-- Shown when all done -->
                <div class="text-center d-none" id="all-done-message">
                    <i class="bi bi-check-circle text-success fs-1"></i>
                    <div class="text-success mt-2">All submarines at target!</div>
                </div>
            </div>
        </div>

        <!-- Notes -->
        <div class="card mb-3">
            <div class="card-header py-2 d-flex justify-content-between align-items-center">
                <span><i class="bi bi-sticky me-2"></i>Notes</span>
                <button class="btn btn-sm btn-link text-muted p-0" id="edit-notes-btn"><i class="bi bi-pencil"></i></button>
            </div>
            <div class="card-body py-2">
                <div id="notes-display" class="{% if not fc_notes %}text-muted fst-italic{% endif %}" style="white-space: pre-wrap; min-height: 2em;">{{ fc_notes or 'No notes' }}</div>
                <div id="notes-edit" style="display: none;">
                    <textarea class="form-control form-control-sm" id="notes-textarea" rows="3">{{ fc_notes or '' }}</textarea>
                    <div class="mt-2 d-flex gap-2">
                        <button class="btn btn-sm btn-primary" id="save-notes-btn">Save</button>
                        <button class="btn btn-sm btn-outline-secondary" id="cancel-notes-btn">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        {% if fc_characters %}
        <!-- Characters -->
        <div class="card mb-3">
            <div class="card-header py-2">
                <i class="bi bi-people me-2"></i>Characters
            </div>
            <div class="card-body py-2">
                {% for char in fc_characters %}
                <div class="d-flex justify-content-between align-items-center {% if not loop.last %}mb-2 pb-2 border-bottom border-secondary{% endif %}">
                    <div>
                        <div>{{ char.name }}</div>
                        <small class="text-muted">{{ char.world }}</small>
                    </div>
                    <div class="text-end small">
                        <span class="text-muted">{{ "{:,}".format(char.ceruleum) }}</span> <i class="bi bi-droplet-fill text-info"></i><br>
                        <span class="text-muted">{{ "{:,}".format(char.repair_kits) }}</span> <i class="bi bi-wrench text-secondary"></i>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {% if inventory_parts %}
        <!-- Parts Inventory -->
        <div class="card">
            <div class="card-header py-2">
                <i class="bi bi-box-seam me-2"></i>Parts Inventory
                <span class="badge bg-secondary ms-2">{{ inventory_parts|length }}</span>
            </div>
            <div class="card-body py-2">
                    <div class="row g-1">
                        {% for part in inventory_parts %}
                        <div class="col-6">
                            <small class="d-flex align-items-center gap-1">
                                {% if part.icon_url %}<img src="{{ part.icon_url }}" style="width: 16px; height: 16px;">{% endif %}
                                <span class="text-truncate">{{ part.name }}</span>
                                <span class="text-muted">x{{ part.count }}</span>
                            </small>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
/* Table styling */
#sub-table {
    --bs-table-bg: transparent;
    --bs-table-hover-bg: rgba(255, 255, 255, 0.03);
    --bs-table-color: #fff;
}
#sub-table thead th {
    color: rgba(255, 255, 255, 0.6) !important;
    border-bottom-color: rgba(255, 255, 255, 0.1);
}
#sub-table tbody td {
    color: #fff;
    border-bottom-color: rgba(255, 255, 255, 0.05);
}
#sub-table tbody tr.at-target td {
    color: rgba(255, 255, 255, 0.5);
}
#sub-table tbody tr.future-sub {
    opacity: 0.6;
}
#sub-table.all-at-target .leveling-col {
    display: none;
}

/* Activity list styling */
.activity-item {
    padding: 0.4rem 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}
.activity-item:last-child {
    border-bottom: none;
}

/* Badge colors */
.badge-level-up { background-color: #198754 !important; }
.badge-build-change { background-color: #0dcaf0 !important; color: #000 !important; }
.badge-route-change { background-color: #ffc107 !important; color: #000 !important; }
.badge-sector-unlock { background-color: #6f42c1 !important; }
.badge-submarine-added { background-color: #198754 !important; }
.badge-submarine-removed { background-color: #dc3545 !important; }

/* Card styling - override Bootstrap defaults */
.card {
    --bs-card-bg: rgba(33, 37, 41, 0.5);
    --bs-card-border-color: rgba(255, 255, 255, 0.1);
    --bs-card-cap-bg: rgba(255, 255, 255, 0.05);
    color: #fff;
}
.card-header {
    background: rgba(255, 255, 255, 0.05) !important;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    color: #fff !important;
}
.card-body {
    color: #fff;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    const fcId = '{{ fc_id }}';
    const targetLevel = {{ target_level }};

    // Fetch leveling data
    const apiUrl = new URL('{{ url_for("stats.fc_leveling_data", fc_id=fc_id) }}', window.location.origin);
    apiUrl.searchParams.set('target', targetLevel);

    fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
            renderSummary(data.estimate);
            renderSubmarines(data.estimate.submarines);
        })
        .catch(error => {
            console.error('Error fetching leveling data:', error);
            document.getElementById('sub-tbody').innerHTML = `
                <tr><td colspan="5" class="text-center text-danger py-3">Error loading data</td></tr>
            `;
        });

    function renderSummary(estimate) {
        const maxSubs = estimate.max_subs || 4;
        const pendingUnlocks = estimate.pending_unlocks || 0;
        const atTarget = estimate.subs_at_target;
        const belowTarget = estimate.subs_below_target;
        const completionPct = Math.round((atTarget / maxSubs) * 100);
        const isAllDone = completionPct === 100;

        const statusBadge = document.getElementById('status-badge');
        const inlineStats = document.getElementById('inline-stats');
        const estimateTiers = document.getElementById('estimate-tiers');
        const allDoneMessage = document.getElementById('all-done-message');

        if (isAllDone) {
            // Header stats
            statusBadge.className = 'badge bg-success';
            statusBadge.innerHTML = '<i class="bi bi-check-circle"></i> All at target';
            inlineStats.classList.add('d-none');
            // Leveling card - show done message, hide estimates
            estimateTiers.classList.add('d-none');
            allDoneMessage.classList.remove('d-none');
            document.getElementById('slowest-sub-info').textContent = '';
            document.getElementById('leveling-progress').innerHTML = `<div class="progress-bar bg-success" style="width: 100%"></div>`;
            // Hide Est column
            document.getElementById('sub-table').classList.add('all-at-target');
        } else {
            // Header stats
            statusBadge.classList.add('d-none');
            inlineStats.classList.remove('d-none');
            document.getElementById('inline-at-target').textContent = `${atTarget}/${maxSubs}`;
            document.getElementById('inline-leveling').textContent = belowTarget + (pendingUnlocks > 0 ? `+${pendingUnlocks}` : '');
            document.getElementById('inline-days').textContent = estimate.estimates.expected.days + 'd';
            // Leveling card
            estimateTiers.classList.remove('d-none');
            allDoneMessage.classList.add('d-none');
            document.getElementById('est-optimistic').textContent = estimate.estimates.optimistic.days + 'd';
            document.getElementById('est-expected').textContent = estimate.estimates.expected.days + 'd';
            document.getElementById('est-pessimistic').textContent = estimate.estimates.pessimistic.days + 'd';
            if (estimate.slowest_sub) {
                document.getElementById('slowest-sub-info').textContent = 'Bottleneck: ' + estimate.slowest_sub;
            }
            // Progress bar
            const levelingPct = Math.round((belowTarget / maxSubs) * 100);
            const pendingPct = Math.round((pendingUnlocks / maxSubs) * 100);
            document.getElementById('leveling-progress').innerHTML = `
                <div class="progress-bar bg-success" style="width: ${completionPct}%"></div>
                <div class="progress-bar bg-warning" style="width: ${levelingPct}%"></div>
                ${pendingUnlocks > 0 ? `<div class="progress-bar bg-secondary" style="width: ${pendingPct}%"></div>` : ''}
            `;
            document.getElementById('sub-table').classList.remove('all-at-target');
        }
    }

    function renderSubmarines(submarines) {
        const tbody = document.getElementById('sub-tbody');

        if (!submarines || submarines.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-3">No submarines found</td></tr>`;
            return;
        }

        // Sort: leveling subs first (by expected days desc), then at-target subs, then future/locked subs
        submarines.sort((a, b) => {
            if (a.is_future_sub && !b.is_future_sub) return 1;
            if (!a.is_future_sub && b.is_future_sub) return -1;
            if (a.already_at_target && !b.already_at_target) return 1;
            if (!a.already_at_target && b.already_at_target) return -1;
            if (!a.already_at_target && !b.already_at_target && !a.is_future_sub && !b.is_future_sub) {
                return b.estimates.expected.days - a.estimates.expected.days;
            }
            if (a.is_future_sub && b.is_future_sub) {
                return (a.unlock_rank || 0) - (b.unlock_rank || 0);
            }
            return (a.current_level || 0) - (b.current_level || 0);
        });

        tbody.innerHTML = submarines.map(sub => {
            const atTarget = sub.already_at_target;
            const isFuture = sub.is_future_sub;
            const voyageStatus = sub.voyage_status || 'unknown';
            const hoursRemaining = sub.hours_remaining || 0;

            // Format voyage status badge
            function getStatusBadge() {
                if (isFuture) return '<span class="badge bg-secondary">Locked</span>';
                if (atTarget) {
                    // At target level - show voyage status
                    if (voyageStatus === 'ready') {
                        return '<span class="badge bg-success">Fully Leveled</span>';
                    } else if (voyageStatus === 'returning_soon') {
                        const mins = Math.round(hoursRemaining * 60);
                        return `<span class="badge bg-success">${mins}m</span>`;
                    } else if (voyageStatus === 'voyaging') {
                        const hrs = Math.floor(hoursRemaining);
                        const mins = Math.round((hoursRemaining - hrs) * 60);
                        const timeStr = hrs > 0 ? `${hrs}h${mins}m` : `${mins}m`;
                        return `<span class="badge bg-success">${timeStr}</span>`;
                    }
                    return '<span class="badge bg-success">Fully Leveled</span>';
                } else {
                    // Still leveling - show voyage status
                    if (voyageStatus === 'ready') {
                        return '<span class="badge bg-warning text-dark">Idle</span>';
                    } else if (voyageStatus === 'returning_soon') {
                        const mins = Math.round(hoursRemaining * 60);
                        return `<span class="badge bg-info">${mins}m</span>`;
                    } else if (voyageStatus === 'voyaging') {
                        const hrs = Math.floor(hoursRemaining);
                        const mins = Math.round((hoursRemaining - hrs) * 60);
                        const timeStr = hrs > 0 ? `${hrs}h${mins}m` : `${mins}m`;
                        return `<span class="badge bg-primary">${timeStr}</span>`;
                    }
                    return '<span class="badge bg-warning text-dark">Idle</span>';
                }
            }

            if (isFuture) {
                const unlockSector = sub.unlock_sector || '?';
                return `
                    <tr class="future-sub">
                        <td class="ps-3"><i class="bi bi-lock text-muted me-1"></i>${sub.submarine_name} <small class="text-muted">(${unlockSector})</small></td>
                        <td class="text-center text-muted">-</td>
                        <td class="text-muted">-</td>
                        <td class="text-center leveling-col text-warning">${sub.estimates.expected.days}d</td>
                        <td class="text-center pe-3">${getStatusBadge()}</td>
                    </tr>
                `;
            }

            if (atTarget) {
                return `
                    <tr class="at-target">
                        <td class="ps-3">${sub.submarine_name}${sub.on_unlock_plan ? ' <i class="bi bi-diagram-3 text-info" title="On unlock plan"></i>' : ''}</td>
                        <td class="text-center">${sub.current_level}</td>
                        <td><code>${sub.build || '-'}</code></td>
                        <td class="text-center leveling-col text-muted">-</td>
                        <td class="text-center pe-3">${getStatusBadge()}</td>
                    </tr>
                `;
            }

            return `
                <tr>
                    <td class="ps-3"><strong>${sub.submarine_name}</strong>${sub.on_unlock_plan ? ' <i class="bi bi-diagram-3 text-info" title="On unlock plan"></i>' : ''}</td>
                    <td class="text-center">${sub.current_level}<small class="text-muted">/${sub.target_level}</small></td>
                    <td><code>${sub.build || '-'}</code></td>
                    <td class="text-center leveling-col text-warning fw-semibold">${sub.estimates.expected.days}d</td>
                    <td class="text-center pe-3">${getStatusBadge()}</td>
                </tr>
            `;
        }).join('');
    }

    // Activity Log functionality
    let activityPage = 1;
    let activityPages = 1;
    let activityTotal = 0;
    const activityPerPage = 10;

    function loadActivityLog(page = 1) {
        const activityUrl = new URL(`{{ url_for("stats.fc_activity", fc_id=fc_id) }}`, window.location.origin);
        activityUrl.searchParams.set('page', page);
        activityUrl.searchParams.set('per_page', activityPerPage);

        fetch(activityUrl)
            .then(response => response.json())
            .then(data => {
                activityPage = data.page;
                activityPages = data.pages;
                activityTotal = data.total;
                renderActivityLog(data.activities);
                updateActivityPagination(data);
            })
            .catch(error => {
                console.error('Error fetching activity log:', error);
                document.getElementById('activity-list').innerHTML = `
                    <div class="text-center text-danger py-3">Error loading activity log</div>
                `;
            });
    }

    function renderActivityLog(activities) {
        const container = document.getElementById('activity-list');

        if (!activities || activities.length === 0) {
            container.innerHTML = `<div class="text-center text-muted py-3"><i class="bi bi-clock-history me-2"></i>No activity yet</div>`;
            return;
        }

        container.innerHTML = activities.map(activity => {
            const time = formatActivityTime(activity.created_at);
            const subName = activity.submarine_name || '';
            const badge = getActivityBadge(activity.activity_type);
            const details = formatActivityDetails(activity);

            return `
                <div class="activity-item d-flex justify-content-between align-items-center">
                    <div>
                        ${badge}
                        ${subName ? `<strong class="ms-2">${subName}</strong>` : ''}
                        <span class="text-muted ms-2">${details}</span>
                    </div>
                    <small class="text-muted">${time}</small>
                </div>
            `;
        }).join('');
    }

    function formatActivityTime(isoString) {
        if (!isoString) return '-';
        const date = new Date(isoString);
        const now = new Date();
        const diffMs = now - date;
        const diffHours = diffMs / (1000 * 60 * 60);

        // Show relative time for recent activities
        if (diffHours < 1) {
            const mins = Math.floor(diffMs / (1000 * 60));
            return `${mins}m ago`;
        } else if (diffHours < 24) {
            const hours = Math.floor(diffHours);
            return `${hours}h ago`;
        }

        // Format as date for older activities
        const options = { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
        return date.toLocaleDateString('en-US', options);
    }

    function getActivityBadge(type) {
        const badges = {
            'level_up': '<span class="badge badge-level-up">Level Up</span>',
            'build_change': '<span class="badge badge-build-change">Build</span>',
            'route_change': '<span class="badge badge-route-change">Route</span>',
            'sector_unlock': '<span class="badge badge-sector-unlock">Unlock</span>',
            'submarine_added': '<span class="badge badge-submarine-added">Added</span>',
            'submarine_removed': '<span class="badge badge-submarine-removed">Removed</span>'
        };
        return badges[type] || `<span class="badge bg-secondary">${type}</span>`;
    }

    function formatActivityDetails(activity) {
        const oldVal = activity.old_value;
        const newVal = activity.new_value;

        switch (activity.activity_type) {
            case 'level_up':
                return `<span class="text-muted">${oldVal}</span> <i class="bi bi-arrow-right"></i> <span class="text-success">${newVal}</span>`;
            case 'build_change':
                return `<code class="text-muted">${oldVal}</code> <i class="bi bi-arrow-right"></i> <code>${newVal}</code>`;
            case 'route_change':
                return `<span class="text-muted">${oldVal}</span> <i class="bi bi-arrow-right"></i> <span>${newVal}</span>`;
            case 'sector_unlock':
                return `<span class="text-info">Sectors: ${newVal}</span>`;
            case 'submarine_added':
                return `Build: <code>${newVal || '-'}</code>`;
            case 'submarine_removed':
                return `Was: <code class="text-muted">${oldVal || '-'}</code>`;
            default:
                if (oldVal && newVal) {
                    return `${oldVal} <i class="bi bi-arrow-right"></i> ${newVal}`;
                }
                return newVal || oldVal || '-';
        }
    }

    function updateActivityPagination(data) {
        const rangeEl = document.getElementById('activity-range');
        const prevBtn = document.getElementById('activity-prev');
        const nextBtn = document.getElementById('activity-next');

        if (data.total === 0) {
            rangeEl.textContent = '';
            prevBtn.disabled = true;
            nextBtn.disabled = true;
            return;
        }

        const start = (data.page - 1) * data.per_page + 1;
        const end = Math.min(data.page * data.per_page, data.total);
        rangeEl.textContent = `${start}-${end} of ${data.total}`;

        prevBtn.disabled = !data.has_prev;
        nextBtn.disabled = !data.has_next;
    }

    // Pagination button handlers
    document.getElementById('activity-prev').addEventListener('click', () => {
        if (activityPage > 1) {
            loadActivityLog(activityPage - 1);
        }
    });

    document.getElementById('activity-next').addEventListener('click', () => {
        if (activityPage < activityPages) {
            loadActivityLog(activityPage + 1);
        }
    });

    // Load activity log on page load
    loadActivityLog(1);

    // ==================== NOTES ====================
    const editNotesBtn = document.getElementById('edit-notes-btn');
    const notesDisplay = document.getElementById('notes-display');
    const notesEdit = document.getElementById('notes-edit');
    const notesTextarea = document.getElementById('notes-textarea');
    const saveNotesBtn = document.getElementById('save-notes-btn');
    const cancelNotesBtn = document.getElementById('cancel-notes-btn');

    editNotesBtn.addEventListener('click', () => {
        notesDisplay.style.display = 'none';
        notesEdit.style.display = 'block';
        editNotesBtn.style.display = 'none';
        notesTextarea.focus();
    });

    cancelNotesBtn.addEventListener('click', () => {
        notesEdit.style.display = 'none';
        notesDisplay.style.display = 'block';
        editNotesBtn.style.display = '';
        // Restore original value
        notesTextarea.value = notesDisplay.textContent.trim() === 'No notes yet. Click edit to add.' ? '' : notesDisplay.textContent;
    });

    saveNotesBtn.addEventListener('click', async () => {
        const notes = notesTextarea.value.trim();
        saveNotesBtn.disabled = true;
        saveNotesBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

        try {
            const resp = await fetch(`/stats/fc/${fcId}/notes`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify({ notes: notes })
            });
            const data = await resp.json();
            if (data.success) {
                notesDisplay.textContent = notes || 'No notes yet. Click edit to add.';
                notesDisplay.classList.toggle('fst-italic', !notes);
                notesEdit.style.display = 'none';
                notesDisplay.style.display = 'block';
                editNotesBtn.style.display = '';
            } else {
                alert(data.message || 'Failed to save notes');
            }
        } catch (err) {
            alert('Error saving notes');
        } finally {
            saveNotesBtn.disabled = false;
            saveNotesBtn.innerHTML = '<i class="bi bi-check"></i> Save';
        }
    });
})();
</script>
{% endblock %}
